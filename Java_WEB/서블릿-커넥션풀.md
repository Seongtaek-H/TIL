## 커넥션풀

> 미리 데이터베이스와 연결시킨 상태를 유지하는 기술

`동작과정`

* 톰캣 컨테이너 실행 후 응용 프로그램 실행
* 톰캣 컨테이너 실행시 ConnectionPool 객체 생성
* 생성된 커넥션 객체는 DBMS와 연결
* 데이터베이스와 연동이 필요한 경우 API는 ConnectionPool 객체를 이용하여 메서드 호출, 연동

**`JNDI`** 

> 커넥션풀을 미리 만들어놓을 때 이것을 저장하는 서버. 커넥션뿐 아니라 중요한 객체를 미리 저장해놓기도 함.
>
> 필요한 자원을 키앤밸류 쌍으로 저장한 후 키를 이용해 값을 얻는 방법.
>
> 톰캣 컨테이너가 ConnectionPool 객체를 생성하면 이 객체에 대한 JNDI 이름(key)을 미리 설정하고,
>
> API에서는 데이터베이스와 연동할 때 JNDI 이름으로 접근하여 연동

* 프로젝트의 web.xml에서의 설정

```xml
    <resource-ref>
	  <res-ref-name>jdbc/member</res-ref-name> <!-- 사용하고자 하는 리소스 이름-->
	  <res-type>javax.sql.DataSource</res-type> <!-- 사용하고자 하는 리소스 타입 (=데이터소스) --> 
	  <res-auth>Container</res-auth> <!-- 리소스 권한이 어디에 있는지--> 
	</resource-ref>
```

* tomcat 의 server.xml에서의 설정

```xml
<Context docBase="LoginMVC" path="/LoginMVC" reloadable="true" source="org.eclipse.jst.jee.server:LoginMVC">
	<Resource auth="Container" // 인증주체
              driverClassName="com.mysql.cj.jdbc.Driver" //드라이버 클래스 이름
              maxIdle="4" //동시에 idle 상태로 대기할 수 있는 최대 수
              maxTotal="8" //동시에 최대로 데이터베이스에 연결할 수 있는 Connection 수
              name="jdbc/member" //JDNI 이름
              password="1234" // 데이터베이스 접속 비밀번호
              type="javax.sql.DataSource" //데이터베이스 종류별 DataSource
              url="jdbc:mysql://localhost:3306/kdt13" //접속할 데이터베이스 url
              username="root"/> // 데이터베이스 접속 
</Context>
```

* Connection class 에서의 설정

```java
	public static Connection getConnection() { // requestDispatcher 방법
		Connection con = null;
		Context initCtx = null;
		try {
			initCtx = new InitialContext(); // 최초 환경설정 객체 생성
            // 환경설정 객체에서 java:comp/env 찾아와라
			Context envCtx = (Context)initCtx.lookup("java:comp/env"); 
            // java:comp/env 데이터 가진 객체에서 jdbc/member 식별자 찾아와서 DataSource에 저장해라
			DataSource ds = (DataSource)envCtx.lookup("jdbc/member"); 
			con = ds.getConnection(); // 가져온 데이터소스로 getConnection
		} catch (NamingException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return con;
	}
```

