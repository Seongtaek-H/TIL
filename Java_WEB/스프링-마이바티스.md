## 마이바티스

> ORM(Object-relational Mapping) : 객체와 관계형 데이터베이스의 데이터를 자동으로 매핑해주는 것

`마이바티스 특징`

* SQL 실행 결과를 자바빈즈(자바데이터빈즈) 또는 Map 객체에 매핑해주는 Persistence 솔루션으로 관리 = SQL을 소스코드가 아닌 XML로 분리
* SQL문과 프로그래밍 코드 분리해서 구현
* 데이터소스(커넥션풀) 기능과 트랜잭션 처리 기능 제공

| 설정파일         | 기능                                                         |
| ---------------- | ------------------------------------------------------------ |
| SqlMapConfig.xml | 데이터베이스 연동 시 반환되는 값을 저장할 빈이나, 트랜잭션, 데이터소스 등 마이바티스 관련 정보 설정 |
| member.xml       | 회원 정보 관련 SQL문 작성                                    |

​	※ 설정파일은 src 패키지 아래에 위치



`마이바티스의 SqlSession 클래스에서 제공하는 메서드`

| 메서드                              | 기능                                                         |
| ----------------------------------- | ------------------------------------------------------------ |
| List selectList(query_id)           | id에 대한 select문을 실행하고 레코드를 List 로 반환          |
| List selectList(query_id, 조건)     | id에 대한 select문을 실행하면서 사용되는 조건도 함께 전달    |
| T selectOne(query_id)               | id에 대한 select문을 실행한 후 지정한 타입으로 한 개의 레코드 반환 |
| T selectOne(query_id, 조건)         | id에 대한 select문을 실행하면서 사용되는 조건도 전달         |
| Map<K, V> selectMap(query_id, 조건) | id에 대한 select문을 실행하면서 사용되는 조건도 전달, Map타입으로 레코드 반환 |
| int insert(query_id, Object obj)    | id에 대한 insert문을 실행하면서 obj 객체의 값을 테이블에 추가 |
| int update(query_id, Object ojb)    | obj 객체의 값을 조건문의 수정 값으로 사용해 id에 대한 update문 실행 |
| int delete(query_id, Object ojb)    | ojb 객체의 값을 조건문의 조건 값으로 사용해 id에 대한 delete문을 실행 |



#### 예제

* SqlMapConfig.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-config.dtd">

<configuration>
	<!-- DAO에서 SQL문으로 값을 전달할때 또는 SQL문을 실행한 후 가져온 값을 DAO로 전달할 때 사용할 MemberVO bean 생성 -->
   <typeAliases>
      <typeAlias type="com.spring.ex01.MemberVO" alias="memberVO"/>
   </typeAliases>

   <environments default="development">
     <environment id="development">
        <transactionManager type="JDBC"/>
        <!-- 마이바티스가 연동하는 데이터베이스에 대한 데이터소스 설정 -->
        <dataSource  type="POOLED">
            <property name="driver"  value="oracle.jdbc.driver.OracleDriver" />
            <property  name="url"    value="JDBC:oracle:thin:@localhost:1521:XE" />
            <property name="username" value="scott" />
            <property name="password"  value="tiger"/>        
        </dataSource>
     </environment>
   </environments>

<!-- 마이바티스에서 사용하는 SQL문이 있는 XML파일 위치 지정 -->
<mappers>
   <mapper resource="mybatis/mappers/member.xml"/>
</mappers>
</configuration>
```

* Member.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- member.xml 네임스페이스 지정 -->
<mapper namespace="mapper.member">
	<!-- SQL문을 실행한후 반한되는 레코드들을 SqlMapConfig.xml의 <typeAlias> 태그 에서 지정한 MemberVO bean에 저장 -->
	<resultMap id="memResult" type="memberVO">
		<result property="id" column="id" />
        <result property="pwd" column="pwd" />
        <result property="name" column="name" />
        <result property="email" column="email" />
        <result property="joinDate" column="joinDate" />
	</resultMap> 

	<!-- DAO에서 해당 id를 이용하여 해당 SQL호출, 반한되는 레코드를 memResult에 저장 -->
	<select id="selectAllMemberList" resultMap="memResult">
		<!-- 연산자 오류 방지 -->
      <![CDATA[ 
         select * from t_member	order by joinDate desc	 	
      ]]>
	</select>
</mapper>
```

* MemberServlet : 브라우저에서 요청시 MemberDAO 객체를 생성한 후 selectAllMemberList() 호출

```java
package com.spring.ex01;

import java.io.IOException;
import java.util.List;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@WebServlet("/mem.do")
public class MemberServlet extends HttpServlet {
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		doHandle(request, response);

	}

	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		doHandle(request, response);
	}

	private void doHandle(HttpServletRequest request, HttpServletResponse response)	throws ServletException, IOException {
		request.setCharacterEncoding("utf-8");
		response.setContentType("text/html;charset=utf-8");
		// MemberDAO 객체를 생성하고 selectAllMemberList() 호출
		MemberDAO dao = new MemberDAO();
		List<MemberVO> membersList = dao.selectAllMemberList();
		request.setAttribute("membersList", membersList);
		RequestDispatcher dispatch = request.getRequestDispatcher("test01/listMembers.jsp");
		dispatch.forward(request, response);
	}
}
```

* MemberDAO

```java
package com.spring.ex01;

import java.io.Reader;
import java.util.List;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

public class MemberDAO {
	// SqlSessionFactory : Creates an SqlSession out of a connection or a DataSource
	public static SqlSessionFactory sqlMapper = null;

	private static SqlSessionFactory getInstance() {
		if (sqlMapper == null) {
			try {
				// MemberDAO의 각 메서드 호출시 src/mybatis/SqlMapConfig.xml에서 설정 정보를 읽고 데이터베이스와 연동 준비
				String resource = "mybatis/SqlMapConfig.xml";
				// mybatis/SqlMapConfig.xml의 리소스를 읽어옴
				Reader reader = Resources.getResourceAsReader(resource);
				// 마이바티스를 이용하는 sqlMapper 객체를 가져옴
				sqlMapper = new SqlSessionFactoryBuilder().build(reader);
				reader.close();
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
		return sqlMapper;
	}

	public List<MemberVO> selectAllMemberList() {
		sqlMapper = getInstance();
		// member.xml의 SQL문을 호출하는데 사용되는 SqlSession 객체를 가져옴
		SqlSession session = sqlMapper.openSession();
		List<MemberVO> memlist = null;
		// List selectList(query_id) : id에 대한 select문을 실행한 후 레코드를 List로 반환
		memlist = session.selectList("mapper.member.selectAllMemberList");
		return memlist;
	}
}
```

* MemberVO

```java
package com.spring.ex01;

import java.sql.Date;

public class MemberVO {
	private String id;
	private String pwd;
	private String name;
	private String email;
	private Date joinDate;

	public MemberVO() {
		
	}

	public MemberVO(String id, String pwd, String name, String email) {
		this.id = id;
		this.pwd = pwd;
		this.name = name;
		this.email = email;
	}
	
    // 각 속성에 대한 getter, setter
}
```

* listMembers.jsp

```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8" 
    isELIgnored="false"  %>
 <%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"  %>
<c:set var="contextPath"  value="${pageContext.request.contextPath}"  />

<%
  request.setCharacterEncoding("UTF-8");
%>    

<html>
<head>
<meta charset=UTF-8">
<title>회원 정보 출력창</title>
</head>
<body>
<table border="1"  align="center"  width="80%">
    <tr align="center"   bgcolor="lightgreen">
      <td ><b>아이디</b></td>
      <td><b>비밀번호</b></td>
      <td><b>이름</b></td>
      <td><b>이메일</b></td>
      <td><b>가입일</b></td>
   </tr>
   
 <c:forEach var="member" items="${membersList}" >     
   <tr align="center">
      <td>${member.id}</td>
      <td>${member.pwd}</td>
      <td>${member.name}</td>
      <td>${member.email}</td>
      <td>${member.joinDate}</td>
      
    </tr>
  </c:forEach>   
</table>
<a  href="${contextPath}/member/memberForm.do"><h1 style="text-align:center">회원가입</h1></a>
</body>
</html>
```



 
